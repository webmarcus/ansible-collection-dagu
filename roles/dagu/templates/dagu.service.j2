# Dagu Systemd Service
# Managed by Ansible - DO NOT EDIT MANUALLY
# Node: {{ inventory_hostname }} ({{ dagu_node_type }})

[Unit]
Description=Dagu Workflow Scheduler
Documentation=https://dagu.readthedocs.io/
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User={{ dagu_user }}
Group={{ dagu_group }}
{% if dagu_distributed_mode == 'worker' %}
ExecStart=/usr/local/bin/dagu worker
{% elif dagu_distributed_mode == 'coordinator' %}
# Coordinator: run start-all with coordinator flags for distributed mode
ExecStart=/usr/local/bin/dagu start-all \
  --coordinator.host={{ dagu_coordinator_host }} \
  --coordinator.port={{ dagu_coordinator_port }}{% if dagu_coordinator_advertise is defined %} \
  --coordinator.advertise={{ dagu_coordinator_advertise }}{% endif %}
{% else %}
# Standalone: run start-all (scheduler + web UI only, no coordinator)
ExecStart=/usr/local/bin/dagu start-all
{% endif %}
Restart={{ dagu_service_restart }}
RestartSec={{ dagu_service_restart_sec }}

# Security
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths={{ dagu_install_dir }}

# Environment
Environment="DAGU_HOME={{ dagu_install_dir }}"
Environment="DAGU_CONFIG={{ dagu_config_dir }}/config.yaml"
Environment="DAGU_HOST={{ dagu_host }}"
Environment="DAGU_PORT={{ dagu_port }}"
{% if dagu_enable_basic_auth %}
Environment="DAGU_BASIC_AUTH_PASSWORD={{ dagu_basic_auth_password }}"
{% endif %}

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=dagu

[Install]
WantedBy=multi-user.target

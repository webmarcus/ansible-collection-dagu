---
# Dagu installation and configuration

- name: Setup dagu user and directories
  ansible.builtin.include_tasks: setup.yml
  tags: [dagu, setup]

- name: Check if Dagu is already installed
  ansible.builtin.stat:
    path: "/usr/local/bin/dagu"
  register: dagu_binary
  tags: [dagu, install]

- name: Get installed Dagu version
  ansible.builtin.command: /usr/local/bin/dagu version
  register: installed_version
  changed_when: false
  failed_when: false
  when: dagu_binary.stat.exists
  tags: [dagu, install]

- name: Download and install Dagu
  when: not dagu_binary.stat.exists or (installed_version.stdout is defined and dagu_version not in installed_version.stdout)
  tags: [dagu, install]
  block:
    - name: Create temporary directory for Dagu download
      ansible.builtin.tempfile:
        state: directory
        suffix: dagu
      register: dagu_temp_dir

    - name: Detect system architecture
      ansible.builtin.set_fact:
        dagu_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' if ansible_architecture == 'aarch64' else ansible_architecture }}"

    - name: Download Dagu binary
      ansible.builtin.get_url:
        url: "https://github.com/dagu-org/dagu/releases/download/v{{ dagu_version }}/dagu_{{ dagu_version }}_linux_{{ dagu_arch }}.tar.gz"
        dest: "{{ dagu_temp_dir.path }}/dagu.tar.gz"
        mode: '0644'
      when: dagu_temp_dir.path is defined

    - name: Extract Dagu binary
      ansible.builtin.unarchive:
        src: "{{ dagu_temp_dir.path }}/dagu.tar.gz"
        dest: "{{ dagu_temp_dir.path }}"
        remote_src: yes
      when: dagu_temp_dir.path is defined

    - name: Remove old Dagu binary
      ansible.builtin.file:
        path: /usr/local/bin/dagu
        state: absent
      become: yes

    - name: Install Dagu binary
      ansible.builtin.copy:
        src: "{{ dagu_temp_dir.path }}/dagu"
        dest: /usr/local/bin/dagu
        mode: '0755'
        remote_src: yes
      become: yes
      notify: restart dagu
      when: dagu_temp_dir.path is defined

    - name: Clean up temporary directory
      ansible.builtin.file:
        path: "{{ dagu_temp_dir.path }}"
        state: absent
      when: dagu_temp_dir.path is defined

- name: Create Dagu configuration from template
  ansible.builtin.template:
    src: config.yaml.j2
    dest: "{{ dagu_config_dir }}/config.yaml"
    owner: root
    group: "{{ dagu_group }}"
    mode: "{{ config_file_mode }}"
  notify: restart dagu
  tags: [dagu, config]

- name: Create base configuration file
  ansible.builtin.copy:
    content: "{{ dagu_base_config_content }}"
    dest: "{{ dagu_base_config_file }}"
    owner: "{{ dagu_user }}"
    group: "{{ dagu_group }}"
    mode: '0644'
  when: dagu_create_base_config
  notify: restart dagu
  tags: [dagu, config]

- name: Create Dagu systemd service
  ansible.builtin.template:
    src: dagu.service.j2
    dest: /etc/systemd/system/dagu.service
    owner: root
    group: root
    mode: '0644'
  notify:
    - reload systemd
    - restart dagu
  tags: [dagu, service]

- name: Setup Git integration
  when: git_integration_enabled
  tags: [dagu, git]
  block:
    - name: Install Git SSH key for dagu user
      ansible.builtin.copy:
        content: "{{ git_ssh_key }}"
        dest: "{{ dagu_home }}/.ssh/id_ed25519"
        owner: "{{ dagu_user }}"
        group: "{{ dagu_group }}"
        mode: '0600'
      when: git_ssh_key is defined and git_ssh_key | length > 0
      no_log: true

    - name: Add GitHub to known_hosts
      ansible.builtin.known_hosts:
        name: github.com
        key: "{{ lookup('pipe', 'ssh-keyscan -t ed25519 github.com') }}"
        path: "{{ dagu_home }}/.ssh/known_hosts"
        state: present
      become_user: "{{ dagu_user }}"

    - name: Create Git sync DAG from template
      ansible.builtin.template:
        src: sync-dags-from-git.yaml.j2
        dest: "{{ dagu_install_dir }}/dags/sync-dags-from-git.yaml"
        owner: "{{ dagu_user }}"
        group: "{{ dagu_group }}"
        mode: '0644'
      notify: restart dagu

- name: Enable and start Dagu service
  ansible.builtin.systemd:
    name: dagu
    enabled: yes
    state: started
    daemon_reload: yes
  tags: [dagu, service]

- name: Wait for Dagu to be ready
  ansible.builtin.wait_for:
    host: "{{ dagu_host }}"
    port: "{{ dagu_port }}"
    delay: 2
    timeout: 30
  when: not ansible_check_mode
  tags: [dagu, verify]

- name: Verify Dagu is running
  ansible.builtin.uri:
    url: "http://{{ dagu_host }}:{{ dagu_port }}"
    status_code: 200
  register: dagu_health
  retries: 3
  delay: 5
  until: dagu_health.status is defined and dagu_health.status == 200
  when: not ansible_check_mode
  tags: [dagu, verify]

- name: Trigger initial DAG sync from Git
  when:
    - git_integration_enabled
    - not ansible_check_mode
  tags: [dagu, git]
  block:
    - name: Wait for Dagu to stabilize
      ansible.builtin.pause:
        seconds: 5

    - name: Trigger sync-dags-from-git DAG
      ansible.builtin.uri:
        url: "http://{{ dagu_host }}:{{ dagu_port }}/api/v2/dags/sync-dags-from-git.yaml/start"
        method: POST
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body: "{}"
        body_format: json
        status_code: [200, 201]
        timeout: 300
      register: sync_trigger_result
      retries: 3
      delay: 5
      until: sync_trigger_result.status in [200, 201]
      failed_when: false

    - name: Wait for initial sync to complete
      ansible.builtin.pause:
        seconds: 10
      when: sync_trigger_result.status in [200, 201]

    - name: Display sync trigger result
      ansible.builtin.debug:
        msg: >
          {% if sync_trigger_result.status in [200, 201] %}
          ✅ Initial DAG sync triggered successfully. All DAG files from {{ git_repo_url }} are being synced.
          {% else %}
          ⚠️  Initial DAG sync trigger failed (status: {{ sync_trigger_result.status | default('unknown') }}).
          You can manually trigger the sync from Dagu UI: http://{{ dagu_host }}:{{ dagu_port }}
          {% endif %}
